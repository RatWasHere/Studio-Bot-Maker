<html>

    <link rel="stylesheet" href="main.css">
    <meta charset="utf8">
    <div style="justify-content: center; width: 100%; align-content: center; margin-left: auto; margin-right: auto; align-items: center; justify-items: center;">
<div class="flexbox fbh">
    <div class="actionBar" id="actionbar" style="z-index: 2;">

    </div>
    <div id="edutor" class="actionBar fullsize">
        <br>
        <div class="text clsr">Group Name</div>
        <div class="inputBar" contenteditable="true" id="Command_Name" onkeyup="if (this.innerText.split('').length > 25) {let fk = this.innerText.split(''); let count = 0; this.innerHTML = ''; this.blur(); for (let i in fk) { count++; if (count < 25) {this.innerHTML += fk[i]; this.focus();}else {this.blur()} }}" onblur="updateName(this)"></div>
        <div class="sepbar"></div>
        <div id="commandActions" class="action noanims" style="width: 88%">Using 0 Actions</div>
        <br>
        <div class="flexbox" style="height: 5%; justify-content: center;">
            <div id="rawData" class="barbutton" onclick="switchGroups()"><div class="barbuttontexta" id="wedf" >Group Trigger</div></div>
        <div id="rawData" class="barbutton"onclick="duplicate()"><div class="barbuttontexta" >Duplicate</div></div>
        <div id="rawData" class="barbutton" onclick="checkErrors()"><div class="barbuttontexta">Check Errors</div></div>
    </div>
        <div class="sepbar"></div>
        <div class="tiled" id="tld">
            <div class="tiledbottom" id="status">✓ • No Issues Found</div>
            <br>
            <div class="flexbox" id="issues"></div>
            <br>
        </div>
</div>
    </div>

<div class="switchBar felxbox" id="bbar" style="display: flex; padding-top: 3.5px; padding-bottom: 3.5px;"><div class="barbutton center unrounded" style="margin-left: 30px !important; margin-right: 10px;" onclick="newObject()" ><div class="barbuttontext" style="font-size: 45px;"><b>+</b></div></div><div class="barbutton unrounded center flexbox" style="justify-content: center;"><div  onclick="moveUp()" class="barbuttonhalf flexbox" style="justify-content: center;"><div class="barbuttontext">▲</div></div><div class="barbuttonhalfr flexbox" style="justify-content: center;"  onclick="moveDown()"><div class="barbuttontext">▼</div></div></div><div class="barbutton unrounded center" onclick="switchObjs(this)" id="objswitch" style="margin-left: auto !important; margin-right: 30px;"><div class="barbuttontext">◀▶</div></div></div>

<div class="bottombar" onclick="modifyBar()" id="bottombar">•••</div>
</div>
    <script src="./AppData/Kits/EditorBones.js"></script>
    <script>
const fese = require('fs')
try {
    fese.readFileSync(processPath + '\\AppData\\data.json', 'utf8')
} catch (err) {

    document.body.innerHTML = `<div class="flexbox" style="height: 50vh; margin-top: 24vh;">
    <div class="ring"></div>
    <div class="barbuttontexta">Hold on, Studio Bot Maker is downloading a few things!</div></div>`
    setTimeout(() => {
        location.reload()
    }, 10000)}

        let lastButton;
        let pinHTML;
      
    function commandData() {
        let elmd = document.getElementById('commandData')
        elmd.style.animationName = 'expandFrom'
        elmd.style.animationDuration = '0.5s'
        elmd.style.height = '40%'
        elmd.style.maxHeight = '1000%'
        elmd.onclick = () => {}
        elmd.style.borderRadius = '22px'
        setTimeout(() => {
            for (let action in datjson.commands[lastObj]) {
                elmd.innerHTML += `<div class="action"><div>${action}</div> - ${datjson.commands[lastObj].action}</div>`
            }
        }, 500)
    }
      let ActionTile = document.getElementById('actionbar');
      let SWT = document.getElementById('switchTask')
      let CmdName = document.getElementById('Command_Name')



      function editAction(ect) {
        lastAct = ect.id
        let action = lastAct
        document.onkeydown = null
        lastHighlighted.style.backgroundColor = '#232323'
        let edutor = document.getElementById('edutor');
        let bbar = document.getElementById('bbar')
        edutor.style.animationDuration = '0.6s'
        edutor.style.animationName = 'moveFrom'
        bbar.style.animationDuration = '0.6s'
        bbar.style.animationName = 'moveunder'
        ActionTile.style.animationDuration = '0.6s'
        document.getElementById('bottombar').style.animationName = 'fadeout'
        document.getElementById('bottombar').style.animationDuration = '0.4s'
        ActionTile.style.animationName = 'moveFrom'
            pinHTML = edutor.innerHTML;
            let htmle = "<br>"
            let UIdata = require(`${processPath}\\AppData\\Actions\\${datjson.commands[lastObj].actions[ect.id].file}`).UI
            console.log(UIdata)
            for (let e in UIdata) {
                console.log(UIdata[e], datjson.commands[lastObj].actions[lastAct].data)

                let ems = e
                if (ems == 'largeInput') {
                    htmle = `${htmle} <div class="largeInput" contentEditable="true" id="${UIdata[e]}">${datjson.commands[lastObj].actions[lastAct].data[UIdata[e]]}</div>`
                }
                if (ems.startsWith('input')) {
                    htmle = `${htmle} <div class="input" contentEditable="true" id="${UIdata[e]}">${datjson.commands[lastObj].actions[lastAct].data[UIdata[e]]}</div>`
                }
                if (ems.startsWith('sepbar')) {
                    htmle = `${htmle} <div class="sepbars"></div>`
                }
                if (ems == 'ButtonBar') { 
                    let ButtonBar = "";
                    let HighlightedButton;
                    let extraElements = ''
                    for (let scl in UIdata[ems].buttons) {
                        let button = UIdata[ems].buttons[scl];
                        console.log(button)
                        if (datjson.commands[lastObj].actions[lastAct].data.button == button) {
                            console.log('primary button found')
                            ButtonBar = `${ButtonBar}<div onclick="Bselect(this, '${lastAct}')" class="barbutton marginTB" style="padding: 2px !important; width: 20% !important; height: 2.5em; background-color: #FFFFFF20" id="${button}"><div class="barbuttontexta" style="margin-top: auto; margin-bottom: auto;">${button}</div></div>`
                            lastButton = button
                            if (button.endsWith('*')) {
                                extraElements = `${extraElements} <div class="inputB" id="ExtraData" contenteditable="true">${datjson.commands[lastObj].actions[lastAct].data.ExtraData}</div>`
                            }
                        } else {
                            ButtonBar = `${ButtonBar}<div onclick="Bselect(this, '${lastAct}')" class="barbutton marginTB" style="padding: 2px !important; width: 20% !important; height: 2.5em" id="${button}"><div class="barbuttontexta" style="margin-top: auto; margin-bottom: auto;">${button}</div></div>`
                        }
                    }
                    htmle = `${htmle}<div class="flexbox" style="margin-left: auto; width: 100%;  margin-right: auto; justify-content: center !important;">${ButtonBar} ${extraElements}</div> <br>`
                }
                
                if (ems.startsWith('menuBar')) {
                    MenuBar = ''
                    for (let option in UIdata[ems].choices) {
                        if (datjson.commands[lastObj].actions[lastAct].data[UIdata[ems].storeAs] == UIdata[ems].choices[option]) {
                           let thenm = undefined
                           if (UIdata[ems].extraField) {
                            thenm = UIdata[ems].extraField
                           }
                           console.log(thenm, "thenm")
                            htmle = `${htmle}<div class="baction" id="${lastAct}" style="animation-name: appearfadenmt; width: 90% !important; text-align: left; border-radius: 12px; border-bottom-left-radius: 0px; border-bottom: solid 2px #FFFFFF40; padding-bottom: 0px; border-bottom-right-radius: 0px; padding-left: 0px; padding-right: 0px; margin-bottom: 6px; padding-left: 24px !important; " onclick="openChoices('${UIdata[ems].storeAs}', this, '${thenm}', '${ems}')">${UIdata[ems].choices[option]}</div>`
                            if (UIdata[ems].choices[option].endsWith('*')) {
                                htmle = `${htmle} <div class="selectBar" onkeyup="saveField('${UIdata[ems].extraField}', '${UIdata[ems].storeAs}')" id="${thenm}" contenteditable="true">${datjson.commands[lastObj].actions[lastAct].data[UIdata[ems].extraField]}</div>`
                            }
                        }
                    }
                }


                if (ems.startsWith('text')) {
                    htmle = `${htmle} <div class="text">${UIdata[e]}</div>`
                }
                if (ems.startsWith('btext')) {
                    htmle = `${htmle} <div class="textse">${UIdata[e]}</div>`
                }
                if (ems.startsWith('invisible')) {
                    htmle = `${htmle} <div class="none"></div>`
                }

            }
              setTimeout(() => {
                edutor.innerHTML = htmle;
                var dfs = ActionTile.innerHTML;
                ActionTile.innerHTML = '<br><div class="text blk" style="text-align: center;">Currently Editing <br> <div class="center halftransparent" id="actionName00"> ' + datjson.commands[lastObj].actions[lastAct].name + '</div></div> <br> <div class="flexbox" style="align-content: center; margin-left: auto; margin-right: auto; width: 90%; justify-content: center;"><div class="barbutton" onclick="save_changes(\'' + lastAct + '\')"><br><div class="barbuttontext">✓</div></div><div class="barbutton center" id="cndcl"> <div class="barbuttontext">✕</div></div></div> <div class="daction noanim" style="width: 45%" onclick="selectAction()" id="cakt"><div>Change Action</div></div> <br> <div class="smalltext blk" style="margin-top: auto; text-align: center; font-size: 18px;">Action Of ' + datjson.commands[lastObj].name + ' <br></div> <div class="smalltext blk" style="text-align: center">✓ = Save | ✕ = Discard</div>'
        document.getElementById('cndcl').onclick = () => {restoreTo(dfs, pinHTML)  }
        bbar.style.marginTop = '-40%'
        ActionTile.className = 'actionBar'
        edutor.style.overflowY = 'auto'
        document.getElementById('bottombar').style.opacity = '0%'
        document.getElementById('bottombar').remove()
        bbar.style.opacity = '0%'

            }, 330)
              setTimeout(()=> {
                if (document.getElementById('bottombar')) {
                    document.getElementById('bottombar').remove()
                }
                edutor.style.animationDuration = ''
            edutor.style.animationName = ''
            ActionTile.style.animationDuration = ''
            ActionTile.style.animationName = ''
            bbar.style.animationDuration = ''
            bbar.style.animationName = ''
            fs.writeFileSync(processPath + '\\AppData\\data.json', JSON.stringify(datjson, null, 2))
            delete UIdata
            delete htmle 
            delete edutor
            delete bbar
              }, 610)
    }



    function Bselect(butt, action) {
        console.log('eeeeeee')
        let edutor = document.getElementById('edutor')
        let oldButton = document.getElementById(lastButton);
        oldButton.style.backgroundColor = '#FFFFFF10';
        butt.style.backgroundColor = '#FFFFFF20';
        if (butt.innerText.endsWith('*') && !oldButton.innerText.endsWith('*')) {
            var extrda = document.createElement('div')
            extrda.className = 'inputB'
            extrda.contentEditable = 'true'
            extrda.id = 'ExtraData'
            butt.parentNode.appendChild(extrda) 
        }
        if (!butt.innerText.endsWith('*') && oldButton.innerText.endsWith('*')) {
            document.getElementById('ExtraData').remove()
        }
        lastButton = butt.id
        datjson.commands[lastObj].actions[action].data.button = butt.innerText
        console.log(butt.innerText, datjson.commands[lastObj].actions[action].data.button)
        fs.writeFileSync(processPath + '\\AppData\\data.json', JSON.stringify(datjson, null, 2))
        
    }


    function save_changes(d) {
        let action = lastAct
        console.log(action)
        console.log('started')
        let savd = datjson.commands[lastObj].actions[lastAct]
        var sdd = require(processPath + `\\AppData\\Actions\\${datjson.commands[lastObj].actions[lastAct].file}`)
        delete sdd
        var sdd = require(processPath + `\\AppData\\Actions\\${datjson.commands[lastObj].actions[lastAct].file}`)

        console.log('w')
        for (let i in sdd.UI) {
            let uid = sdd.UI
            let ems = sdd.UI[i]
            console.log(uid)
            console.log(ems)
            if (ems != 'preview' || ems != 'previewName' || !ems.StartsWith('invisible')) {
            if (i == 'ButtonBar' ) {
                if (datjson.commands[lastObj].actions[lastAct].data.button.endsWith('*')) {
                    datjson.commands[lastObj].actions[lastAct].data.ExtraData = document.getElementById('ExtraData').innerText
                } 
            } else {
                if (i.startsWith('text') || i.startsWith('menuBar') || i == 'preview' || i == 'previewName' || i.startsWith('sepbar') || i.startsWith('btext') || i.startsWith('invisible')) {
                     
                } else {
                    try {
                    console.log(document.getElementById(ems))
                    datjson.commands[lastObj].actions[lastAct].data[ems] = document.getElementById(ems).innerText;
                } catch(err) {
                    console.log(err)
                }}

            }
        }
        fs.writeFileSync(processPath + '\\AppData\\data.json', JSON.stringify(datjson, null, 2))
    }}
    function updateName(mnt) {
        datjson.commands[lastObj].name = mnt.innerText.split(' |')[0]
        if (lastType == 0) {
            document.getElementById(lastObj).innerHTML = `<div id="name">${mnt.innerText.split(' |')[0].trim()}</div> <div style="opacity: 50%; margin-left: 7px;"> | ${Object.keys(datjson.commands[lastObj].actions).length} Action(s) Used</div> <div class="deleteActionButton" onclick="deleteObject(this)">✕</div>`
        }


        fs.writeFileSync(processPath + '\\AppData\\data.json', JSON.stringify(datjson, null, 2))
    }

        switchObjs()
        switchObjs()
        highlight(document.getElementById('1'), true, true)
        </script>
    </html>